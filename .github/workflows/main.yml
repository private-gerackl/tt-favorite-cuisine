name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup-dependencies:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Set up Python 3.13
      run: uv python install 3.13

    - name: Install dependencies
      run: uv sync --group test --group linters

    - name: Push python to cache directory
      run:
        rm .venv/bin/python &&
        cp /home/runner/.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/bin/python3.13 .venv/bin/python

    - name: Install Just
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to .venv/bin/

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path:  |
          ~/.cache/uv
          .venv
        key: uv-deps-${{ hashFiles('.github/workflows/main.yml', 'pyproject.toml', 'uv.lock') }}

    - name: Check .venv
      run: |
        ls -la .venv/bin

  checks:
    runs-on: ubuntu-latest
    needs: setup-dependencies
    strategy:
      matrix:
        target: [ruff-fmt-check, ruff-style-check, mypy, safety, up test]

    name: "${{ matrix.target }}"
    steps:
    - uses: actions/checkout@v4

    - name: Restore cached dependencies
      uses: actions/cache@v4
      with:
        path:  |
          ~/.cache/uv
          .venv
        key: uv-deps-${{ hashFiles('.github/workflows/main.yml', 'pyproject.toml', 'uv.lock') }}-v2

    - name: Activate venv
      run: source .venv/bin/activate

    - name: Check .venv
      run: |
        ls -la .venv/bin

    - name: Run just target
      run: .venv/bin/just ${{ matrix.target }}
